<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cotizaciones - Nexus </title>
  <meta name="description" content="Gestión de cotizaciones para servicios de soporte técnico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/cotizaciones.css" />
</head>
<body>
  
  <!-- ==========================================
       SIDEBAR LATERAL
  ========================================== -->
  <aside class="sidebar">
    <!-- Header del Sidebar -->
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fas fa-cube"></i>
      </div>
      <div class="sidebar-title">
        <h2>Nexus </h2>
        <p>v.0.2.34</p>
      </div>
    </div>

    <!-- Usuario con botón + -->
    <div class="sidebar-user">
      <img src="https://ui-avatars.com/api/?name=Juan+Sanchez&background=22CA95&color=fff&bold=true" 
           alt="Usuario" class="user-avatar-sidebar">
      <div class="user-info-sidebar">
        <h3 id="sidebarUserName">Juan Sánchez</h3>
        <p id="sidebarUserRole">Administrador</p>
      </div>
      <div class="add-btn" title="Nuevo" onclick="openNewClientModal()">
        <i class="fas fa-plus"></i>
      </div>
    </div>

    <!-- Sección Módulos -->
    <div class="nav-section">
      <div class="nav-section-title">Módulos</div>
      <a href="dashboard.html" class="nav-item">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </a>
      <a href="clientes.html" class="nav-item">
        <i class="fas fa-users"></i>
        <span>Clientes</span>
      </a>
      <a href="servicios.html" class="nav-item">
        <i class="fas fa-cogs"></i>
        <span>Servicios</span>
      </a>
      <a href="cotizaciones.html" class="nav-item active">
        <i class="fas fa-file-contract"></i>
        <span>Cotizaciones</span>
        <span class="nav-badge" id="navBadgeCotizaciones">0</span>
      </a>
    </div>

    <!-- Footer del Sidebar -->
    <div class="sidebar-footer">
      <div class="version-info">
        <div class="version-icon">
          <i class="fas fa-rocket"></i>
        </div>
        <div class="version-text">
          <h4>NexusCaster</h4>
          <p>ver. 0.2.34</p>
        </div>
        <button class="version-menu">
          <i class="fas fa-ellipsis-h"></i>
        </button>
      </div>
    </div>
  </aside>

  <!-- ==========================================
       CONTENIDO PRINCIPAL
  ========================================== -->
  <main class="main-wrapper">
    
    <!-- Header Superior del Contenido -->
    <header class="content-topbar">
      <div class="topbar-left">
        <button class="menu-toggle" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Buscar cotizaciones, clientes..." id="searchInput">
        </div>
      </div>

      <div class="topbar-right">
        <div class="topbar-actions">
          <button class="action-btn" title="Notificaciones" onclick="window.location.href='notificaciones.html'">
            <i class="fas fa-bell"></i>
            <span class="action-badge">8</span>
          </button>
          <button class="action-btn" title="Mensajes" onclick="window.location.href='mensajes.html'">
            <i class="fas fa-envelope"></i>
            <span class="action-badge">4</span>
          </button>
          <button class="action-btn" title="Configuración" onclick="window.location.href='settings.html'">
            <i class="fas fa-cog"></i>
          </button>
        </div>
        
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <!-- Contenido de Cotizaciones -->
    <div class="cotizaciones-content">
      
      <!-- Header de Cotizaciones -->
      <div class="cotizaciones-header">
        <div class="cotizaciones-text">
          <h1>Cotizaciones</h1>
          <p>Gestiona y crea cotizaciones para tus clientes</p>
        </div>
        <div class="cotizaciones-actions">
          <button class="btn-primary" onclick="scrollToForm()">
            <i class="fas fa-plus"></i>
            Nueva Cotización
          </button>
          <button class="btn-secondary" onclick="exportarCSV()">
            <i class="fas fa-download"></i>
            Exportar CSV
          </button>
        </div>
      </div>

      <!-- Filtros -->
      <section class="filtros-section">
        <div class="filtros-card">
          <h3>Filtrar Cotizaciones</h3>
          <div class="filtros-grid">
            <div class="filtro-item">
              <label for="filtroCliente">Cliente</label>
              <select id="filtroCliente">
                <option value="">-- Todos --</option>
              </select>
            </div>
            <div class="filtro-item">
              <label for="fdesde">Desde</label>
              <input id="fdesde" type="date" />
            </div>
            <div class="filtro-item">
              <label for="fhasta">Hasta</label>
              <input id="fhasta" type="date" />
            </div>
            <div class="filtro-actions">
              <button class="btn-primary" onclick="filtrar()">
                <i class="fas fa-filter"></i>
                Filtrar
              </button>
              <button class="btn-secondary" onclick="listarCotizaciones()">
                <i class="fas fa-times"></i>
                Limpiar
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Resumen de Cotizaciones -->
      <section class="resumen-section">
        <div class="resumen-grid">
          <div class="resumen-card">
            <div class="resumen-icon">
              <i class="fas fa-file-contract"></i>
            </div>
            <div class="resumen-info">
              <h3 id="totalCotizaciones">0</h3>
              <p>Total Cotizaciones</p>
            </div>
          </div>
          <div class="resumen-card">
            <div class="resumen-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="resumen-info">
              <h3 id="totalIngresos">$0.00</h3>
              <p>Total Ingresos</p>
            </div>
          </div>
          <div class="resumen-card">
            <div class="resumen-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="resumen-info">
              <h3 id="totalClientes">0</h3>
              <p>Clientes Activos</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Listado de Cotizaciones -->
      <section class="listado-section">
        <div class="section-header">
          <h3>Listado de Cotizaciones</h3>
          <div class="section-actions">
            <button class="options-btn" onclick="listarCotizaciones()">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        
        <div class="cotizaciones-table">
          <div id="tblCotizaciones">
            <!-- Las cotizaciones se cargarán aquí dinámicamente -->
            <div class="table-empty">
              <i class="fas fa-file-contract"></i>
              <p>No hay cotizaciones registradas</p>
              <button class="btn-primary" onclick="scrollToForm()">
                Crear primera cotización
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Formulario de Creación de Cotización -->
      <section class="form-section" id="formSection">
        <div class="form-card">
          <h3>Crear Cotización</h3>

          <div class="form-grid">
            <div class="form-group">
              <label for="cot_cliente">Cliente (obligatorio)</label>
              <select id="cot_cliente"></select>
            </div>
            <div class="form-group">
              <label for="cot_servicio">Servicio</label>
              <select id="cot_servicio"></select>
            </div>
            <div class="form-group">
              <label for="cot_cantidad">Cantidad</label>
              <input id="cot_cantidad" type="number" min="1" value="1" />
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button class="btn-primary" onclick="agregarItem()">
                <i class="fas fa-plus"></i>
                Agregar ítem
              </button>
            </div>
          </div>

          <div class="items-section">
            <h4>Ítems Agregados</h4>
            <div class="resumen-cot" id="resumenCot"></div>
            <ul id="cot_items" class="items-list"></ul>
          </div>

          <div class="form-actions">
            <button class="btn-primary" onclick="guardarCotizacion()">
              <i class="fas fa-save"></i>
              Guardar Cotización
            </button>
            <button class="btn-secondary" onclick="limpiarFormulario()">
              <i class="fas fa-times"></i>
              Limpiar
            </button>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- SCRIPTS -->
  <script src="js/db.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/cotizaciones.js"></script>
  <script>
    // Funciones auxiliares para la UI
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('active');
    }

    function logout() {
      if (confirm("¿Estás seguro que deseas cerrar sesión?")) {
        localStorage.removeItem("sessionUser");
        location.href = "index.html";
      }
    }

    function toggleNotifications() {
      alert("Panel de notificaciones - En desarrollo");
    }

    function openNewClientModal() {
      alert("Modal de nuevo cliente - En desarrollo");
    }

    function scrollToForm() {
      document.getElementById('formSection').scrollIntoView({ 
        behavior: 'smooth' 
      });
    }

    function limpiarFormulario() {
      itemsTemp = [];
      renderItemsTemp();
      document.getElementById('cot_cantidad').value = 1;
    }

    // Inicialización de la página
    (async function init() {
      const s = localStorage.getItem("sessionUser");
      if (!s) { 
        location.href = "index.html"; 
        return; 
      }

      const user = JSON.parse(s);
      document.getElementById("sidebarUserName").textContent = user.nombre || "Usuario";
      document.getElementById("sidebarUserRole").textContent = user.rol || "Administrador";

      // Actualizar resumen después de cargar datos
      setTimeout(actualizarResumenGeneral, 500);
    })();

    // Actualizar resumen general con datos reales
    async function actualizarResumenGeneral() {
      try {
        await openDB();
        const cotizaciones = await getAll("cotizaciones");
        const clientes = await getAll("clientes");
        
        document.getElementById("totalCotizaciones").textContent = cotizaciones.length;
        document.getElementById("totalClientes").textContent = clientes.length;
        
        const ingresoTotal = cotizaciones.reduce((sum, c) => sum + (parseFloat(c.total) || 0), 0);
        document.getElementById("totalIngresos").textContent = `$${ingresoTotal.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;

        document.getElementById("navBadgeCotizaciones").textContent = cotizaciones.length;
      } catch (error) {
        console.error("Error al actualizar resumen:", error);
      }
    }

    // Búsqueda
    document.getElementById("searchInput")?.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        const query = this.value.trim();
        if (query) {
          alert(`Buscando: "${query}" - En desarrollo`);
        }
      }
    });
  </script>
</body>
</html>


